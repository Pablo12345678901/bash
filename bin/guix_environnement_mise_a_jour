#!/usr/bin/env bash 

# Syntaxe :
# - : aucun argument requis.

source fonctions_personnelles


# Pour la mise à jour manuelle
# Peut pas être mis à jour via un cron car chaque utilisateur doit runner pour soi avec sudo (seul root sans sudo).
declare -a LISTE_STATUTS
STATUT=""

###############################################
echo -e "\nMise à jour de $USER...\n"

# Mise à jour de $USER
COMMANDE="guix package -u"
echo -e "\nRUN : $COMMANDE\n"
$COMMANDE
STATUT="$(statut_retourne $? "$COMMANDE")"
LISTE_STATUTS+=("$STATUT")

COMMANDE="guix pull"
echo -e "\nRUN : $COMMANDE\n"
$COMMANDE
STATUT="$(statut_retourne $? "$COMMANDE")"
LISTE_STATUTS+=("$STATUT")

# 'sudo guix system reconfigure'
#    -> Pas besoin de le faire 2x, juste une fois à la fin
#COMMANDE="sudo guix system reconfigure /etc/config.scm"
#echo -e "\nRUN : $COMMANDE\n"
#$COMMANDE
#STATUT="$(statut_retourne $? "$COMMANDE")"
#LISTE_STATUTS+=("$STATUT")

# Mise à jour de root
echo -e "\nMise à jour de root...\n"

COMMANDE="sudo -i guix package -u"
echo -e "\nRUN : $COMMANDE\n"
$COMMANDE
STATUT="$(statut_retourne $? "$COMMANDE")"
LISTE_STATUTS+=("$STATUT")

COMMANDE="sudo -i guix pull"
echo -e "\nRUN : $COMMANDE\n"
$COMMANDE
STATUT="$(statut_retourne $? "$COMMANDE")"
LISTE_STATUTS+=("$STATUT")

# Mise à jour du système
echo -e "\nMise à jour du système...\n"
COMMANDE="sudo guix system reconfigure /etc/config.scm"
echo -e "\nRUN : $COMMANDE\n"
$COMMANDE
STATUT="$(statut_retourne $? "$COMMANDE")"
LISTE_STATUTS+=("$STATUT")

echo -e "\nRésultat de la mise à jour :\n"
tableau_contenu LISTE_STATUTS

# Redémarrage
echo ""
read -p "Taper enter pour reboot ou control+c pour annuler"
sudo reboot
